name: Build Flask HTML APK with Camera and Storage

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-apk:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip zip wget autoconf libtool pkg-config openjdk-17-jdk lld ccache

          pip install --user python-for-android flask

      - name: Prepare Flask App
        run: |
          mkdir -p templates static
          echo '<!DOCTYPE html><html><body><h1>Flask WebView App</h1><button onclick="startCamera()">Open Camera</button><script>function startCamera() { navigator.mediaDevices.getUserMedia({ video: true }).then(stream => { const video = document.createElement("video"); video.srcObject = stream; video.play(); document.body.appendChild(video); }).catch(err => alert("Camera error: " + err)); }</script></body></html>' > templates/index.html

          echo "from flask import Flask, render_template" > main.py
          echo "app = Flask(__name__, static_folder='static', template_folder='templates')" >> main.py
          echo "@app.route('/')\ndef index():\n    return render_template('index.html')" >> main.py
          echo "if __name__ == '__main__':\n    app.run(host='0.0.0.0', port=5000)" >> main.py

      - name: Build APK
        run: |
          export PATH=$PATH:$HOME/.local/bin
          p4a apk \
            --private . \
            --package=org.example.flaskapp \
            --name="FlaskApp" \
            --version=1.0 \
            --bootstrap=webview \
            --port=5000 \
            --requirements=flask \
            --permission=INTERNET \
            --permission=CAMERA \
            --permission=WRITE_EXTERNAL_STORAGE \
            --permission=READ_EXTERNAL_STORAGE \
            --arch=armeabi-v7a \
            --output FlaskApp.apk

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: FlaskApp-APK
          path: FlaskApp.apk
